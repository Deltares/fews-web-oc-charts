<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Ensemble Tech Demo</title>
        <style>


            body {
                background-color : rgb(44,44,44);
                font: 10px sans-serif;
                margin: 20px;
            }

            .dst-indicator {
              fill: yellow
            }

            #chart-container-1 {
                display: block;
                width: 100%;
                height: 100vh;
                max-height: 414px;
                fill: white;
            }

            #polar-dot {
                fill: #999999;
                stroke: white;
            }

            #chart-legend-1 {
                display: block;
                fill: white;
            }

            /* .chart-line { fill: none; stroke: skyblue; } */
            #control-line { fill: none; stroke: red; stroke-dasharray : 4,2; stroke-width: 2px; }

            #median-line { fill: none; stroke: white; stroke-width: 2px; }



            /* div.tooltip { position: absolute; text-align: left; min-width: 60px; min-height: 28px; padding: 2px; font: 12px sans-serif; background:
rgba(0, 0, 0,.8); border: 0px;
border-top-right-radius: 4px;
border-bottom-right-radius: 4px; pointer-events: none; } */

            /* Tooltip text */
            .tooltip {
/* visibility: hidden; */
position: absolute;
margin-left: 5px;
min-width: 50px;
background-color: black;
color: #fff;
text-align: center;
padding: 5px 0;
border-radius: 6px;
z-index: 1;
opacity: 0;
transition: opacity 0.3s;
/* top: -50%;
left: 125%; */
pointer-events: none;

}

.tooltip::after {
content: "";
position: absolute;
top: 50%;
right: 100%;
margin-top: -5px;
border-width: 5px;
border-style: solid;
border-color: transparent black transparent transparent;
}


        </style>
</script>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.16.0/d3.js"></script>
        <script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
        <link rel="stylesheet" href="/dist/wb-charts.css">
    </head>
    <body>
        <div>
            <div id="chart-container-1"></div>
            <div id="chart-legend-1"></div>
        </div>
        <button type="button" data-id="median" onclick="toggleChart(this)">median</button>
        <button type="button" data-id="control" onclick="toggleChart(this)">control</button>
        <button type="button" data-id="percent50,percent90" onclick="toggleChart(this)">percentile</button>
        <button type="button" data-id="ensemble" onclick="toggleChart(this)">ensemble</button>

        <script src="/dist/wb-charts.umd.js"></script>
        <script type="text/javascript">

    var container = document.getElementById("chart-container-1");
    var axis =  new wbCharts.CartesianAxis(container, null, null,
      { x : [ {type: 'time', position: 'bottom' } ],
        y : [ {label: 'Waterstand [cm]', position: 'left'} ],
        margin: {left: 50, right: 50 }
      });
    var legend = new wbCharts.Legend( [
        {selector: 'median', label : 'Middelste (P50)'},
        {selector: 'control', label :'Controle'},
        {selector: 'percent90', label :'90% interval'} ,
        {selector: 'percent50', label :'50% interval'},
        {selector: 'ensemble', label : 'Verstoord'},
        {selector: 'missing', label : 'Missing'},
        ]
        ,document.getElementById("chart-legend-1"));

    var currentTime = new wbCharts.CurrentTime({x: {axisIndex: 0}});
    var dstIndicator = new wbCharts.DstIndicator({x: {axisIndex: 0}});
    var levelSelect = new wbCharts.LevelSelect(function(x) {console.log(x)} );
    percentile = function(p, data) {
        var points = data;
        points.sort(function (a, b) { return a - b });
        if (Array.isArray(p)) {
            var result = [];
            for (i = 0; i < p.length; ++i) {
                var x = p[i] * (points.length + 1);
                var x1 = Math.floor(x);
                var frac = x - x1;
                result.push(points[x1 - 1] + frac * (points[x1] - points[x1 - 1]));
            }
            return result;
        } else {
            var x = p * (points.length + 1);
            var x1 = Math.floor(x);
            var frac = x - x1;
            return points[x1 - 1] + frac * (points[x1] - points[x1 - 1]);
        }
    };

    // var refDate = new Date(2019,02,31);
    var refDate = new Date();
    var mouseOver = new wbCharts.MouseOver(['control', 'median','percent90']);
    var escalationLevels = [
      { id: 'laag', val: -100, color: 'rgba(205, 133, 63,.5)', c: '<' },
      { id: 'verhoogd', val: 100, color: 'rgba(255, 215, 0,.5)', c: '>' },
      { id: 'hoog', val: 110, color: 'rgba(255, 150, 0,.5)', c: '>' },
      { id: 'extreem', val: 140, color: 'rgba(255, 0, 0,.5)', c: '>' }
    ]

    var escalationsVisitor = new wbCharts.WarningLevels(escalationLevels);
    var zoom = new wbCharts.ZoomHandler();

    axis.accept(legend);
    function dataload() { d3.json("ensemble.json").then(function (data) {
      var nEnsemble = data.values[0].length;
      var members = Array(nEnsemble);
      var percentiles = [[],[],[]];

      for (s = 0; s< nEnsemble ; s++) {
          members[s]= Array();
      }
      var plotEnsemble = [];
      var medianTime = (data.times[0] + data.times[data.times.length-1])/2;
      console.log(new Date( medianTime * 1000 ) )

      data.times.forEach( function(time, index) {
          var dateTime = new Date( (time - medianTime) * 1000 + refDate.getTime() );
          for (i = 0; i < nEnsemble; i++) {
              members[i].push({ x: dateTime , y: data.values[index][i] })
          }
          var points = data.values[index]
          percentiles[0].push({ x: dateTime, y: percentile(.5,points)  });
          percentiles[1].push({ x: dateTime, y: percentile([0.25, 0.75], points) });
          percentiles[2].push({ x: dateTime, y: percentile([0.05, 0.95], points) });
      })


      var plotMedian = new wbCharts.ChartLine(percentiles[0], {});
      var plotControl = new wbCharts.ChartLine(members[0], {});

      var plotControl1 = new wbCharts.ChartLine(members[0], {});
      var plotMedian1 = new wbCharts.ChartMarker(percentiles[0], {});
      var plotPercentile50 = new wbCharts.ChartArea(percentiles[1], {});
      var plotPercentile90 = new wbCharts.ChartArea(percentiles[2], {});

      let style90 = {
        'fill': 'skyblue', 'stroke': 'skyblue'
      };
      let style50 = {
        'fill': 'deepskyblue', 'stroke': 'deepskyblue'
      }
      const styleLine = {
        fill: 'none', stroke: 'white'
      }
      plotPercentile90.addTo(axis,{x :{ key: "x", axisIndex: 0}, y: {key: "y", axisIndex: 0} }, 'percent90', style90);
      plotPercentile50.addTo(axis,{x :{ key: "x", axisIndex: 0}, y: {key: "y", axisIndex: 0} }, 'percent50', style50);

      for (i = 1; i< nEnsemble; i++) {
        var plotEnsemble=new wbCharts.ChartLine(members[i], {});
        let declaration = { 'stroke': 'green',
        'stroke-width': '1px',
        'fill': 'none',
        'opacity': '.5'
        }

        // new CSSStyleDeclaration()
        // declaration.setProperty("stroke", "black");
        // declaration.setProperty("stroke-width", "1px");
        // declaration.setProperty("fill", "none");
        // declaration.setProperty("opacity", ".");
        plotEnsemble.addTo(axis, {x :{ key: "x", axisIndex: 0}, y: {key: "y", axisIndex: 0} }, 'ensemble', declaration );
      }

      plotControl1.addTo(axis,{x :{ key: "x", axisIndex: 0}, y: {key: "y", axisIndex: 0} }, 'control', '#control-line');
      plotMedian1.addTo(axis, {x :{ key: "x", axisIndex: 0}, y: {key: "y", axisIndex: 0} }, 'median', '#median-line');
      axis.redraw({x:{ autoScale: true}, y: {autoScale: true} });
      axis.zoom();
      // legend.visit(axis);
      // axis.accept(legend);
      axis.accept(currentTime);
      axis.accept(dstIndicator);
      axis.accept(levelSelect);
      axis.accept(escalationsVisitor);
      axis.accept(zoom);
      axis.accept(mouseOver);
    });}
    window.setTimeout(dataload,1000);

    window.onresize = function() { axis.resize();};

    function toggleChart (element) {
      console.log('toggle', element)
      let ids = element.getAttribute('data-id').split(',');
      // console.log()
      for (const id of ids) {
        console.log(id)
        wbCharts.toggleChartVisisbility(axis, id)
      }
    }

    </script>


    </body>
</html>
