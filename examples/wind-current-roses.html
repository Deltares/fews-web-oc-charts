<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Wind and Current Roses Tech Demo</title>
  <style>

    html, body {
      height: 100%;
      margin: 0px;
      font-size: 16px;
      font-family: sans-serif;
    }

    .wbcharts svg {
      overflow: visible;
    }

    body {
      background-color : rgb(44,44,44);
    }

    text {
      fill: white;
    }

    title {
      stroke: black;
    }

    .axis-canvas {
      fill:rgb(89, 89, 89);
    }

    .r-axis{
      display: none;
    }

    .r-grid{
      display: none;
    }

    .chart-row {
      height: 49%;
      position: relative;
      display: block;
    }

    #chart-wind-rose {
      position: relative;
      display: inline-block;
      width: 49%;
      height: 100%;
    }

    #chart-wind-rose .data-field{
      text-anchor: middle
    }

    #polar-range {
      fill:rgba(79, 193, 255, 0.5);
      stroke: none;
    }

    #polar-line { fill: none; stroke: rgb(79, 193, 255); stroke-width: 3px; }
    #polar-line-forecast { fill: none; stroke: rgb(214, 39, 40); stroke-width: 3px; }

    #chart-wind-speed-time {
      position: relative;
      display: block;
      width: 100%;
      height: calc(100% - 60px);
    }

    #chart-wind-direction-time {
      position: relative;
      display: block;
      width: 100%;
      height: calc(100% - 60px);
    }

    #wind-line { fill: none; stroke: rgb(79, 193, 255); stroke-width: 1.5px;}
    #windstoot-line { fill: none; stroke: rgb(156, 220, 254); stroke-width: 1.5px;}

    #wind-forecast-line{ fill: none; stroke: rgb(214, 39, 40); stroke-width: 1.5px;}

    #winddirection-line{ fill: none; stroke:rgb(79, 193, 255); stroke-width: 1.5px;}
    #directionforecast-rose {stroke: rgb(214, 39, 40); stroke-width: 1px; }

  </style>

  <script
    src="https://code.jquery.com/jquery-3.3.1.js"
    integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
    crossorigin="anonymous">
  </script>
  <script src="https://d3js.org/d3.v7.js"></script>
  <script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
  <link rel="stylesheet" href="../dist/wb-charts-dark.css">
</head>
<body>
  <div class="chart-row">
    <div id="chart-wind-rose"></div>
    <div id="chart-current-rose"></div>
  </div>
  <script src="../dist/wb-charts.umd.js"></script>
  <script type="text/javascript">

    var polarAxis;

    var windDirectionMeasurement;
    var windDirectionForecast;
    var windSpeedMeasurement;
    var windSpeedForecast;
    var windDirectionRange;
    var datafieldWindDirection;
    var datafieldWindSpeed;
    var datafieldWindStoot;

    var target = 40;
    var transitionTime = null;

    var unitsSpeed = [{unit: ' m/s', factor : 1.0 }, {unit: ' kt', factor: 1.943844 }, {unit: ' km/h', factor: 3.6 }, {unit: ' Bft', scale: wbCharts.scaleBeaufort }]
    var unitsStoot = [{unit: ' m/s', factor : 1.0 }, {unit: ' kt', factor: 1.943844 }, {unit: ' km/h', factor: 3.6 } ]
    var degree = [{unit: '°', factor : 1.0, precision: '.0f' }, {unit: '', scale : wbCharts.scaleWindCategories }]

    function setupWindRose(windRichtingMetingen,
    windRichtingVerwachtingen,
    windSnelheiMetingen, windSnelheiVerwachtingen, windStoot,
    allWindSpreidingR, allWindSpreidingV,
    allWindStoot) {

      // Wind rose chart
      var containerWindrose = document.getElementById("chart-wind-rose");
      polarAxis = new wbCharts.PolarAxes(containerWindrose, null, null, {
        angular: {
          direction: wbCharts.Direction.CLOCKWISE,
          intercept: Math.PI/ 2,
          format: (value) => `${value}°`
        },
        innerRadius: 0.5
      });
      windDirectionMeasurement = new wbCharts.ChartLine(windRichtingMetingen[0], {transitionTime: transitionTime, radial:{includeInTooltip:false}, tooltip: {anchor: 'pointer'}});
      windDirectionForecast = new wbCharts.ChartLine(windRichtingVerwachtingen[0], {transitionTime: transitionTime, radial:{includeInTooltip:false}, tooltip: {anchor: 'pointer'}});
      windDirectionRange = new wbCharts.ChartRange(allWindSpreidingR[0], {transitionTime: transitionTime, radial:{includeInTooltip:false}, tooltip: {anchor: 'center'}});

      // Invisible lines used for datafields
      windSpeedMeasurement = new wbCharts.ChartLine(windSnelheiMetingen[0], {});
      windSpeedForecast = new wbCharts.ChartLine(windSnelheiVerwachtingen[0], {});
      windSurge = new wbCharts.ChartLine(windSnelheiVerwachtingen[0], {});

      windDirectionRange.addTo(polarAxis, { radial: { key: "x" }, angular: { key: "y" } }, 'direction-range', '#polar-range');
      windDirectionMeasurement.addTo(polarAxis, { radial: { key: "x" }, angular: { key: "y" } }, 'direction-measured', '#polar-line');
      windDirectionForecast.addTo(polarAxis, { radial: { key: "x" }, angular: { key: "y" } }, 'direction-forecast','#polar-line-forecast');
      windSpeedMeasurement.addTo(polarAxis, { radial: { key: "x" }, angular: { key: "y" } }, 'wind-measured', '#wind-line');
      windSpeedForecast.addTo(polarAxis, { radial: { key: "x" }, angular: { key: "y" } }, 'wind-forecast', '#wind-forecast-line');
      windSurge.addTo(polarAxis, { radial: { key: "x" }, angular: { key: "y" } }, 'windstoot', '#windstoot-line');

      datafieldWindDirection = new wbCharts.DataField(
      polarAxis.canvas, {
        selector: ['direction-measured', 'direction-forecast'],
        labelField: {text: 'richting', dy: '-50px' },
        valueField: [{dy: '-30px', hyphen: ' / '}, {units: degree }]
      }
      );

      datafieldWindSpeed = new wbCharts.DataField(
      polarAxis.canvas, {
        selector: ['wind-measured', 'wind-forecast'],
        labelField: {text: 'windsnelheid', dy: '-10px' },
        valueField: [{dy:'10px', hyphen: ' / '}, {units: unitsSpeed }]
      });

      datafieldWindStoot = new wbCharts.DataField(
      polarAxis.canvas, {
        selector: 'windstoot',
        labelField: {text: 'windstoot', dy: '30px' },
        valueField: {dy: '50px', units: unitsStoot }
      });

      // Draw
      polarAxis.redraw();

      // Add visitors
      polarAxis.accept(datafieldWindDirection);
      polarAxis.accept(datafieldWindSpeed);
      polarAxis.accept(datafieldWindStoot);
    }


    function updateWindrose(
      windRichtingMetingen,
      windRichtingVerwachtingen,
      windSnelheidMetingen,
      windSnelheidVerwachtingen,
      windSpreidingR,
      windSpreidingV,
      windStoot,
    ) {
      const position = 277; // Some time index
      windDirectionMeasurement.data = windRichtingMetingen[position];
      windDirectionForecast.data = windRichtingVerwachtingen[position];
      windDirectionRange.data = windSpreidingR[position];
      windSpeedMeasurement.data = windSnelheidMetingen[position];
      windSpeedForecast.data = windSnelheidVerwachtingen[position];
      windSurge.data = windStoot[position];

      polarAxis.redraw();
    }

    function get_wind_data() {
      var request = new XMLHttpRequest();
      request.onreadystatechange = function(){
        if (this.readyState == 4 & this.status == 200) {
          var data = JSON.parse(this.responseText);
          var metingvalues = data.meting.values;
          var verwachtingvalues = data.verwachting.values;
          var spreidingvalues = data.spreiding.values;
          var times = data.meting.times;
          timesdata = [];

          var windSpeedTimeSeriesM =[];
          var windDirectionTimeSeriesM =[];
          var windStootTimeSeriesM =[];
          for (var i = 0; i < data.meting.times.length; i++) {
            if (data.meting.values[i][0] || data.meting.values[i][2] || data.meting.values[i][3] ) {
              var dateTime =  new Date( data.meting.times[i] * 1000);
              var val = data.meting.values[i][2] !== null ?  data.meting.values[i][2] * 0.1 : null;
              windSpeedTimeSeriesM.push({ t: dateTime , y: val, d: data.meting.values[i][0] })
              windDirectionTimeSeriesM.push({ t: dateTime , y: val, d: data.meting.values[i][0] })
              val = data.meting.values[i][2] !== null ?  data.meting.values[i][3] * 0.1 : null;
              windStootTimeSeriesM.push({ t: dateTime , y: val})
            }
          }

          var windSpeedTimeSeriesF =[];
          var windDirectionTimeSeriesF =[];
          for (var i = 0; i < data.verwachting.times.length; i++) {
            if (data.verwachting.values[i][0] || data.verwachting.values[i][2] ) {
              var dateTime=new Date( data.verwachting.times[i] * 1000);
              windSpeedTimeSeriesF.push({ t: dateTime , y: data.verwachting.values[i][0] * 0.1, d: data.verwachting.values[i][1] })
              windDirectionTimeSeriesF.push({ t: dateTime , y: data.verwachting.values[i][1] })
            }
          }

          var allWindRichtingMetingen = [];
          var allWindRichtingVerwachtingen = [];
          var allWindSnelheidMetingen = [];
          var allWindSnelheidVerwachtingen = [];
          var allWindSpreidingR = [];
          var allWindSpreidingV = [];
          var allWindStoot = [];
          for (var i = 0; i < times.length; i++) {
            var timedatapresent = metingvalues[i][0] !== null ||
            metingvalues[i][2] !== null ||
            metingvalues[i][3] !== null;
            timesdata.push([times[i],timedatapresent]);

            var metingRichtingData1 = {};
            var metingRichtingData2 = {};

            metingRichtingData1.x = 0;
            metingRichtingData1.y = metingvalues[i][0];

            metingRichtingData2.x = metingvalues[i][0] !== null ? 1 : 0;
            metingRichtingData2.y = metingvalues[i][0];
            allWindRichtingMetingen.push([metingRichtingData1,metingRichtingData2]);

            var verwachtingRichtingData1 = {};
            verwachtingRichtingData1.x = 0;
            verwachtingRichtingData1.y = verwachtingvalues[i][1];

            var verwachtingRichtingData2 = {
              x : verwachtingvalues[i][1] !== null ? 1 : 0,
              y : verwachtingvalues[i][1]
            };
            allWindRichtingVerwachtingen.push([verwachtingRichtingData1,verwachtingRichtingData2]);

            var metingSnelheidData1 = {};
            var metingSnelheidData2 = {};
            metingSnelheidData1.x = 0;
            metingSnelheidData1.y = metingvalues[i][2] !== null ? Math.abs(0.1 * metingvalues[i][2]) : null;  // scale down by factor 10 for m/sec
            metingSnelheidData2.x = 0; // line should be invisible
            metingSnelheidData2.y = metingSnelheidData1.y;
            allWindSnelheidMetingen.push([metingSnelheidData1,metingSnelheidData2]);

            var metingStootData1 = {};
            var metingstootData2 = {};
            metingStootData1.x = 0;
            metingStootData1.y = metingvalues[i][3] !== null ? Math.abs(0.1 * metingvalues[i][3]): null;  // scale down by factor 10 for m/sec
            metingstootData2.x = 0; // line should be invisible
            metingstootData2.y = metingStootData1.y;
            allWindStoot.push([metingStootData1,metingstootData2]);

            var verwachtingSnelheidData1 = {};
            var verwachtingSnelheidData2 = {};
            verwachtingSnelheidData1.x = 0;
            verwachtingSnelheidData1.y = Math.abs(0.1 * verwachtingvalues[i][0]);  // scale down by factor 10 for m/sec
            verwachtingSnelheidData2.x = 0; // line should be invisible
            verwachtingSnelheidData2.y = Math.abs(0.1 * verwachtingvalues[i][0]);  // scale down by factor 10 for m/sec
            allWindSnelheidVerwachtingen.push([verwachtingSnelheidData1,verwachtingSnelheidData2]);

            var windSpreidingRData = {};
            windSpreidingRData.x = [0, 1];

            if(  spreidingvalues[i][3] < spreidingvalues[i][2] ) {
              if(  spreidingvalues[i][3] < metingvalues[i][0] ) {
                windSpreidingRData.y = [spreidingvalues[i][2], spreidingvalues[i][3]+360];
              } else {
                windSpreidingRData.y = [spreidingvalues[i][2]-360, spreidingvalues[i][3]];
              }
            } else {
              windSpreidingRData.y = [spreidingvalues[i][2], spreidingvalues[i][3]];
            }
            allWindSpreidingR.push([windSpreidingRData]);

            var windSpreidingVData = {};
            windSpreidingVData.x = [0, (spreidingvalues[i][0] !== null ? 1 : 0)];
            windSpreidingVData.y = [0.1 * Math.abs(spreidingvalues[i][0]), 0.1 * Math.abs(spreidingvalues[i][1])] ;
            allWindSpreidingV.push([windSpreidingVData]);
          }

          updateWindrose(allWindRichtingMetingen,allWindRichtingVerwachtingen,allWindSnelheidMetingen,
            allWindSnelheidVerwachtingen, allWindSpreidingR, allWindSpreidingV, allWindStoot);
        }
      }
      var initRange = [[{ x:[0,1], y:[0,1], v:100}],[{ x:[0,1], y:[0,1], v:100}]];
      var initScalar = [[{ x:0, y:0 }, { x:1, y:1} ]];

      setupWindRose(initScalar, initScalar, initScalar, initScalar, initScalar, initRange, initRange, initRange);
      request.open("GET", '/examples/wind_data3.json',true);
      request.send();
    }

    get_wind_data();
  </script>
</body>
</html>
