<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Wind and Current Roses Tech Demo</title>
  <style>

    html, body {
      height: 100%;
      margin: 0px;
      font-size: 16px;
      font-family: sans-serif;
    }

    .wbcharts svg {
      overflow: visible;
    }

    body {
      background-color : rgb(44,44,44);
    }

    text {
      fill: white;
    }

    title {
      stroke: black;
    }

    .axis-canvas {
      fill:rgb(89, 89, 89);
    }

    .r-axis{
      display: none;
    }

    .r-grid{
      display: none;
    }

    .chart-row {
      height: 49%;
      position: relative;
      display: block;
    }

    .chart-wind-rose {
      position: relative;
      display: inline-block;
      width: 49%;
      height: 100%;
    }

    .chart-wind-rose .data-field{
      text-anchor: middle
    }

  </style>

  <script
    src="https://code.jquery.com/jquery-3.3.1.js"
    integrity="sha256-2Kok7MbOyxpgUVvAk/HJ2jigOSYS2auK4Pfzbm7uH60="
    crossorigin="anonymous">
  </script>
  <script src="https://d3js.org/d3.v7.js"></script>
  <script src="https://d3js.org/d3-selection-multi.v1.min.js"></script>
  <link rel="stylesheet" href="../dist/wb-charts-dark.css">
</head>
<body>
  <div class="chart-row">
    <div id="chart-wind-rose1" class="chart-wind-rose"></div>
    <div id="chart-current-rose1"></div>
  </div>
  <div class="chart-row">
    <div id="chart-wind-rose2" class="chart-wind-rose"></div>
    <div id="chart-current-rose2"></div>
  </div>
  <script src="../dist/wb-charts.umd.js"></script>
  <script type="text/javascript">

    const styleForecast = {
      fill: 'rgb(214, 39, 40)',
      stroke: 'rgb(214, 39, 40)',
      'stroke-width': '1.5px'
    }
    const styleMeasurement = {
      fill: 'rgb(79, 193, 255)',
      stroke: 'rgb(79, 193, 255)',
      'stroke-width': '1.5px'
    }
    const styleSurge = {
      fill: 'none',
      stroke: 'rgb(156, 220, 254)',
      'stroke-width': '1.5px'
    }
    const styleRange = {
      fill: 'rgba(79, 193, 255, 0.5)',
      stroke: 'none'
    }

    var polarAxisWind1;
    var polarAxisWind2;

    var windDirectionMeasurement;
    var windSpeedMeasurement;
    var windSpeedForecast;
    var windDirectionRange;
    var datafieldWindDirection;
    var datafieldWindSpeed;
    var datafieldWindStoot;

    var transitionTime = null;

    var unitsSpeed = [{unit: ' m/s', factor : 1.0 }, {unit: ' kt', factor: 1.943844 }, {unit: ' km/h', factor: 3.6 }, {unit: ' Bft', scale: wbCharts.scaleBeaufort }]
    var unitsStoot = [{unit: ' m/s', factor : 1.0 }, {unit: ' kt', factor: 1.943844 }, {unit: ' km/h', factor: 3.6 } ]
    var degree = [{unit: '°', factor : 1.0, precision: '.0f' }, {unit: '', scale : wbCharts.scaleWindCategories }]

    const arrowSize = 64

    function setupWindRose(windRichtingMetingen,
    windRichtingVerwachtingen,
    windSnelheidMetingen, windSnelheidVerwachtingen, windStoot,
    allWindSpreidingR, allWindSpreidingV,
    allWindStoot) {

      // Wind rose charts
      // Create two charts, with different intersects and direction
      var containerWindrose1 = document.getElementById("chart-wind-rose1");
      polarAxisWind1 = new wbCharts.PolarAxes(containerWindrose1, null, null, {
        angular: {
          direction: wbCharts.Direction.CLOCKWISE,
          intercept: Math.PI/ 2,
          format: (value) => `${value}°`
        },
        innerRadius: 0.5
      });

      var containerWindrose2 = document.getElementById("chart-wind-rose2");
      polarAxisWind2 = new wbCharts.PolarAxes(containerWindrose2, null, null, {
        angular: {
          direction: wbCharts.Direction.ANTICLOCKWISE,
          intercept: Math.PI,
          format: (value) => `${value}°`
        },
        innerRadius: 0.5
      });

      const polarAxesWind = [polarAxisWind1, polarAxisWind2]
      polarAxesWind.forEach(polarAxisWind => {

        position = 277
        windDirectionRange = new wbCharts.ChartRange(allWindSpreidingR[position], {transitionTime: transitionTime, radial:{includeInTooltip:false}, tooltip: {anchor: 'center'}});

        // Invisible lines used for datafields
        windSpeedMeasurement = new wbCharts.ChartLine(windSnelheidMetingen[position], {});
        windSpeedForecast = new wbCharts.ChartLine(windSnelheidVerwachtingen[position], {});
        windSurge = new wbCharts.ChartLine(windStoot[position], {});

        // Arrows
        windDirectionArrowMeasurement = new wbCharts.ChartArrow( windRichtingMetingen[position], {transitionTime: transitionTime, symbol: { size: arrowSize }});
        windDirectionArrowForecast = new wbCharts.ChartArrow( windRichtingVerwachtingen[position], {transitionTime: transitionTime,  symbol: { size: arrowSize }, radial:{includeInTooltip:false}, tooltip: {anchor: 'pointer'}});

        windDirectionRange.addTo(polarAxisWind, { radial: { key: "x" }, angular: { key: "y" } }, 'wind-direction-range', styleRange);
        windSpeedMeasurement.addTo(polarAxisWind, { radial: { key: "x" }, angular: { key: "y" } }, 'wind-measured', styleMeasurement);
        windSpeedForecast.addTo(polarAxisWind, { radial: { key: "x" }, angular: { key: "y" } }, 'wind-forecast', styleForecast);
        windSurge.addTo(polarAxisWind, { radial: { key: "x" }, angular: { key: "y" } }, 'windstoot', styleSurge);
        windDirectionArrowMeasurement.addTo(polarAxisWind, { radial: { key: "x" } , angular: {key: "y" } }, 'wind-direction-measurement-arrow', styleMeasurement);
        windDirectionArrowForecast.addTo(polarAxisWind, { radial: { key: "x" } , angular: {key: "y" } }, 'wind-direction-forecast-arrow', styleForecast);

        datafieldWindDirection = new wbCharts.DataField(
        polarAxisWind.canvas, {
          selector: ['wind-direction-measurement-arrow', 'wind-direction-forecast-arrow'],
          labelField: {text: 'richting', dy: '-50px' },
          valueField: [{dy: '-30px', hyphen: ' / '}, {units: degree }]
        }
        );

        datafieldWindSpeed = new wbCharts.DataField(
        polarAxisWind.canvas, {
          selector: ['wind-measured', 'wind-forecast'],
          labelField: {text: 'windsnelheid', dy: '-10px' },
          valueField: [{dy:'10px', hyphen: ' / '}, {units: unitsSpeed }]
        });

        datafieldWindStoot = new wbCharts.DataField(
        polarAxisWind.canvas, {
          selector: 'windstoot',
          labelField: {text: 'windstoot', dy: '30px' },
          valueField: {dy: '50px', units: unitsStoot }
        });

        // Draw
        polarAxisWind.redraw();

        // Add visitors
        polarAxisWind.accept(datafieldWindDirection);
        polarAxisWind.accept(datafieldWindSpeed);
        polarAxisWind.accept(datafieldWindStoot);
      })
    }

    function get_wind_data() {
      var request = new XMLHttpRequest();
      request.onreadystatechange = function(){
        if (this.readyState == 4 & this.status == 200) {
          var data = JSON.parse(this.responseText);
          var metingvalues = data.meting.values;
          var verwachtingvalues = data.verwachting.values;
          var spreidingvalues = data.spreiding.values;
          var times = data.meting.times;
          timesdata = [];

          var windSpeedTimeSeriesM =[];
          var windDirectionTimeSeriesM =[];
          var windStootTimeSeriesM =[];
          for (var i = 0; i < data.meting.times.length; i++) {
            if (data.meting.values[i][0] || data.meting.values[i][2] || data.meting.values[i][3] ) {
              var dateTime =  new Date( data.meting.times[i] * 1000);
              var val = data.meting.values[i][2] !== null ?  data.meting.values[i][2] * 0.1 : null;
              windSpeedTimeSeriesM.push({ t: dateTime , y: val, d: data.meting.values[i][0] })
              windDirectionTimeSeriesM.push({ t: dateTime , y: val, d: data.meting.values[i][0] })
              val = data.meting.values[i][2] !== null ?  data.meting.values[i][3] * 0.1 : null;
              windStootTimeSeriesM.push({ t: dateTime , y: val})
            }
          }

          var windSpeedTimeSeriesF =[];
          var windDirectionTimeSeriesF =[];
          for (var i = 0; i < data.verwachting.times.length; i++) {
            if (data.verwachting.values[i][0] || data.verwachting.values[i][2] ) {
              var dateTime=new Date( data.verwachting.times[i] * 1000);
              windSpeedTimeSeriesF.push({ t: dateTime , y: data.verwachting.values[i][0] * 0.1, d: data.verwachting.values[i][1] })
              windDirectionTimeSeriesF.push({ t: dateTime , y: data.verwachting.values[i][1] })
            }
          }

          var allWindRichtingMetingen = [];
          var allWindRichtingVerwachtingen = [];
          var allWindSnelheidMetingen = [];
          var allWindSnelheidVerwachtingen = [];
          var allWindSpreidingR = [];
          var allWindSpreidingV = [];
          var allWindStoot = [];
          for (var i = 0; i < times.length; i++) {
            var timedatapresent = metingvalues[i][0] !== null ||
            metingvalues[i][2] !== null ||
            metingvalues[i][3] !== null;
            timesdata.push([times[i],timedatapresent]);

            var metingRichtingData = {
              x : [metingvalues[i][0] !== null ? 1 : 0, 0],
              y : [metingvalues[i][0], metingvalues[i][0]]
            }
            allWindRichtingMetingen.push([metingRichtingData]);


            var verwachtingRichtingData = {
              x : [verwachtingvalues[i][0] !== null ? 1 : 0, 0],
              y : [verwachtingvalues[i][1], verwachtingvalues[i][1]]
            };
            allWindRichtingVerwachtingen.push([verwachtingRichtingData]);

            var metingSnelheidData1 = {};
            var metingSnelheidData2 = {};
            metingSnelheidData1.x = 0;
            metingSnelheidData1.y = metingvalues[i][2] !== null ? Math.abs(0.1 * metingvalues[i][2]) : null;  // scale down by factor 10 for m/sec
            metingSnelheidData2.x = 0; // line should be invisible
            metingSnelheidData2.y = metingSnelheidData1.y;
            allWindSnelheidMetingen.push([metingSnelheidData1,metingSnelheidData2]);

            var metingStootData1 = {};
            var metingstootData2 = {};
            metingStootData1.x = 0;
            metingStootData1.y = metingvalues[i][3] !== null ? Math.abs(0.1 * metingvalues[i][3]): null;  // scale down by factor 10 for m/sec
            metingstootData2.x = 0; // line should be invisible
            metingstootData2.y = metingStootData1.y;
            allWindStoot.push([metingStootData1,metingstootData2]);

            var verwachtingSnelheidData1 = {};
            var verwachtingSnelheidData2 = {};
            verwachtingSnelheidData1.x = 0;
            verwachtingSnelheidData1.y = Math.abs(0.1 * verwachtingvalues[i][0]);  // scale down by factor 10 for m/sec
            verwachtingSnelheidData2.x = 0; // line should be invisible
            verwachtingSnelheidData2.y = Math.abs(0.1 * verwachtingvalues[i][0]);  // scale down by factor 10 for m/sec
            allWindSnelheidVerwachtingen.push([verwachtingSnelheidData1,verwachtingSnelheidData2]);

            var windSpreidingRData = {};
            windSpreidingRData.x = [0, 1];

            if(  spreidingvalues[i][3] < spreidingvalues[i][2] ) {
              if(  spreidingvalues[i][3] < metingvalues[i][0] ) {
                windSpreidingRData.y = [spreidingvalues[i][2], spreidingvalues[i][3]+360];
              } else {
                windSpreidingRData.y = [spreidingvalues[i][2]-360, spreidingvalues[i][3]];
              }
            } else {
              windSpreidingRData.y = [spreidingvalues[i][2], spreidingvalues[i][3]];
            }
            allWindSpreidingR.push([windSpreidingRData]);

            var windSpreidingVData = {};
            windSpreidingVData.x = [0, (spreidingvalues[i][0] !== null ? 1 : 0)];
            windSpreidingVData.y = [0.1 * Math.abs(spreidingvalues[i][0]), 0.1 * Math.abs(spreidingvalues[i][1])] ;
            allWindSpreidingV.push([windSpreidingVData]);
          }

          setupWindRose(allWindRichtingMetingen,
            allWindRichtingVerwachtingen,
            allWindSnelheidMetingen, allWindSnelheidVerwachtingen, allWindStoot,
            allWindSpreidingR, allWindSpreidingV,
            allWindStoot)
        }
      }
      request.open("GET", '/examples/wind_data3.json',true);
      request.send();
    }

    get_wind_data();
  </script>
</body>
</html>
